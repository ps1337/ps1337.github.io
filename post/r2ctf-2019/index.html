<!DOCTYPE html>
<html lang="en-us">

<head>
     
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>r2con 2019 CTF Writeups</title>
    <style>

    html body {
        font-family: 'Raleway', sans-serif;
        background-color: white;
    }

    :root {
        --border-width:  5px ;
    }

</style>





<link rel="stylesheet" href="https://bananamafia.dev//css/font.css">


 <link rel="stylesheet" href="https://bananamafia.dev//css/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://bananamafia.dev//css/bootstrap-min.css" integrity="">


<link rel="stylesheet" href="https://bananamafia.dev//css/main.css">


<link rel="stylesheet" href="https://bananamafia.dev//css/font-awesome.min.css" integrity="">

 


<script src="/js/highlight.min.js"></script>


<script src="/js/python.min.js"></script> 
<script src="/js/cpp.min.js"></script> 
<script src="/js/json.min.js"></script> 
<script src="/js/go.min.js"></script> 

<script>
  hljs.initHighlightingOnLoad();
</script>




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-143157939-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-143157939-1');
</script>





















<script src="/js/jquery.min.js"></script>


<script src="/js/bootstrap.min.js"></script>


<script>$(document).on('click', function () { $('.collapse').collapse('hide'); })</script>


<script src="/js/confetti.browser.js"></script> <meta name="generator" content="Hugo 0.101.0" />
    

    
</head>




<body>
     
    <nav class="navbar navbar-default navbar-fixed-top">

        <div class="container">

            <div class="navbar-header">

                <a class="navbar-brand visible-xs" href="#">r2con 2019 CTF Writeups</a>

                <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

            </div>

            <div class="collapse navbar-collapse">

                
                <ul class="nav navbar-nav">
                    
                    <li><a href="/">Home</a></li>
                    
                    <li><a href="/post/">Posts</a></li>
                    
                    <li><a href="/project/">Projects</a></li>
                    
                    <li><a href="/recipe/">Recipes</a></li>
                    
                </ul>
                

                
                <ul class="nav navbar-nav navbar-right">
                    
                    <li class="navbar-icon"><a href="mailto:banana-#@#-bananamafia.dev"><i class="fa fa-envelope-o"></i></a></li>
                    
                    <li class="navbar-icon"><a href="https://github.com/ps1337/"><i class="fa fa-github"></i></a></li>
                    
                    <li class="navbar-icon"><a href="https://twitter.com/CaptnBanana"><i class="fa fa-twitter"></i></a></li>
                    
                    <li class="navbar-icon"><a href="/index.xml"><i class="fa fa-rss"></i></a></li>
                    
                    <li class="navbar-icon"><a href=""><i class="fa fa-toggle-off"></i></a></li>
                    
                    <li class="navbar-icon"><a href="https://www.youtube.com/watch?v=ao2GL3NAWQU"><i class="fa fa-envira"></i></a></li>
                    
                </ul>
                

            </div>

        </div>

    </nav>


    <script>
        
        
        

        
        $(".fa-toggle-off, .fa-toggle-on").parent().removeAttr("href");

        
        window.onload = setMode();

        function isLightMode() {

            const currentTheme = localStorage.getItem('bananamafia_theme') ? localStorage.getItem('bananamafia_theme') : null;

            if (currentTheme == "light" || currentTheme == null) {
                return true;
            }
            else {
                return false;
            }
        }

        function setMode() {
            if (isLightMode()) {
                setLight();
            }
            else {
                setDark();
            }
        }

        function setDark() {
            document.documentElement.setAttribute('data-theme', 'dark');
            localStorage.setItem('bananamafia_theme', 'dark');

            $(".fa-toggle-off").each(function (i) {
                $(this).removeClass("fa-toggle-off");
                $(this).addClass("fa-toggle-on");
            });
            setAltImgs();
        }

        function setLight() {
            document.documentElement.setAttribute('data-theme', 'light');
            localStorage.setItem('bananamafia_theme', 'light');

            $(".fa-toggle-on").each(function (i) {
                $(this).removeClass("fa-toggle-on");
                $(this).addClass("fa-toggle-off");
            });
            setAltImgs();
        }

        function setAltImgs() {
            var lightMode = isLightMode();
            $(".alt-img").each(function (idx) {
                if (lightMode) {
                    
                    var newSrc = $(this).attr("src").replace("_dark", "");
                }
                else {
                    
                    var imgExt = $(this).attr("src").split(".").pop();
                    var newSrc = $(this).attr("src").substr(0, $(this).attr("src").lastIndexOf(".")) + "_dark." + imgExt;
                }

                $(this).fadeOut(250, function () {
                    $(this).attr("src", newSrc);
                });
                $(this).fadeIn(250);
            });
        }

        $(".fa-toggle-off, .fa-toggle-on").on("click", function () {
            const currentTheme = localStorage.getItem('bananamafia_theme') ? localStorage.getItem('bananamafia_theme') : null;
            $("body").addClass("transition-bg");
            $("nav").addClass("transition-bg");
            if (currentTheme == "dark") {
                setLight();
            } else {
                setDark();
            }

            setTimeout(function () {
                $("body").removeClass("transition-bg");
                $("nav").removeClass("transition-bg");
            }, 500);

        });

        $(document).ready(function () {
            
            $(".fa-envira").parent().mouseenter(function () {
                confetti.reset();

                confetti({
                    useWorker: true,
                    particleCount: 200,
                    angle: 90,
                    spread: 70,
                    origin: {
                        x: 0.5, y: 1
                    },
                    startVelocity: 60
                });
            });
            setAltImgs();
        });
    </script>


<main id="main">

    <div class="item">

    
    
    

    

    <h4><a href="/post/r2ctf-2019/">r2con 2019 CTF Writeups</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/r2"><kbd class="item-tag">r2</kbd></a>
    
    <a href="https://bananamafia.dev/tags/radare2"><kbd class="item-tag">radare2</kbd></a>
    
    <a href="https://bananamafia.dev/tags/ctf"><kbd class="item-tag">ctf</kbd></a>
    
    <a href="https://bananamafia.dev/tags/reverse-engineering"><kbd class="item-tag">reverse-engineering</kbd></a>
    

</div>


    <br>
    <div class="content-width text-justify"><h1 id="r2boy1">r2boy1</h1>
<p>The first GameBoy challenge was rather easy. The idea was to talk to the Pancake character in-game in order to get the flag. The problem is that Pancake chills behind a wall. One possible solution was to glitch through the wall, however I&rsquo;ve solved this using static analysis.</p>
<p>Going through the strings and searching for a possible dialog yields interesting strings:</p>
<pre tabindex="0"><code>[0x00054075]&gt; izzq~pancake
0x54016 37 36 Find pancake\nthrough a game\nglitch!
0x5403c 30 29 I am pancake, the\nr2 prophet.
</code></pre><p>Inspecting this region  directly yields the flag in plain text:</p>
<pre tabindex="0"><code>[0x00054075]&gt; pxq@0x5403c
0x0005403c  0x6e6170206d612049  0x6874202c656b6163   I am pancake, th
0x0005404c  0x6f72702032720a65  0x5202002e74656870   e.r2 prophet...R
0x0005405c  0x2e7265626d656d65  0x7065654b02002e2e   emember.....Keep
0x0005406c  0x00200a6d6c616320  0x776c6120646e6102    calm. ..and alw
0x0005407c  0x2065737520737961  0x206d6f72660a3272   ays use r2.from
0x0005408c  0x6568030021746967  0x7320656874206572   git!..here the s
0x0005409c  0x6f740a7465726365  0x7320726576656e20   ecret.to never s
0x000540ac  0x32720a3a7065656c  0x7b02006e6f630200   leep:.r2..con..{
0x000540bc  0x75705f7961790200  0x30665f656b346b6e   ..yay_punk4ke_f0
0x000540cc  0x007d02000a646e77  0x6d61472077654e02   wnd...}..New Gam
</code></pre><h1 id="r2boy2">r2boy2</h1>
<p>First of all, I&rsquo;m not sure whether I&rsquo;ve solved this in the intended way :D The challenge was to talk to another in-game character and get the flag that way. It turns out that the character won&rsquo;t give out the flag if just you ask him. All he answers is: <code>Don't ask for the flag!</code>. Too bad.</p>
<p>I&rsquo;ve received the flag using two methods and didn&rsquo;t use <code>radare2</code> at all:</p>
<ol>
<li>
<p>The game can be debugged using <a href="http://bgb.bircd.org">bgb</a>. During a debugging session it&rsquo;s possible to read the loaded image data that&rsquo;s being used to display the game environment. This data contains the flag, stored as map image data.</p>
</li>
<li>
<p>I&rsquo;ve emulated the ROM using <code>vbam</code>. This emulator implements a convenient feature that allows users to speed up time while holding the space key. All I did was holding the space key while also holding <code>q</code> in order to constantly start the dialog with the character that knows about the flag. Lets&rsquo; check out what happens after a few seconds:</p>
</li>
</ol>
<p><img src="/img/r2ctf-2019/r2boy2.gif" alt="lol"></p>
<h1 id="r2baby">r2baby</h1>
<p>This ARM64 challenge prints out the flag that&rsquo;s derived from user input after passing some checks that have to be reversed to let the input pass. My setup was to use QEMU to emulate the ARM binary:</p>
<pre tabindex="0"><code>qemu-aarch64-static -g 1337 ./babyr2
</code></pre><p>The <code>-g</code> parameter spawns a GDB server that can be accessed with <code>r2</code>:</p>
<pre tabindex="0"><code>r2 -a arm -b 64 -d gdb://127.0.0.1:1337
</code></pre><p>This way, the checks can be observed dynamically. Setting breakpoints didn&rsquo;t work, so I&rsquo;ve used <code>dcu &lt;address&gt;</code> instead.</p>
<p>Let&rsquo;s analyze the checks, directly from the <code>main()</code> function.</p>
<h3 id="first-check">First check:</h3>
<pre tabindex="0"><code>[...]
; argc
str w0, [arg_2ch]
[...]
ldr w0, [arg_2ch]
cmp w0, 4
</code></pre><p>This is a basic check that&rsquo;s ensures that three command line arguments are passed. Remember that <code>argv[0]</code> is the name of the executable itself.</p>
<h3 id="second-check">Second Check:</h3>
<pre tabindex="0"><code>movz w0, 0xcafe
cmp w1, 0
</code></pre><p>It seems that the first argument has to be <code>0xcafe</code>. So let&rsquo;s pass <code>51966</code>, its decimal representation, as the first argument.</p>
<h3 id="third-and-fourth-check">Third and Fourth Check:</h3>
<pre tabindex="0"><code>&lt;Weird Stuff&gt;
cmp w1, 3
&lt;Other Stuff&gt;
cmp w1, 8
</code></pre><p>I&rsquo;ve fiddled around with the second argument in order to pass both checks and didn&rsquo;t bother analyzing in depth&rsquo;s going on. I&rsquo;ve used <code>51977</code> for this. I&rsquo;ve skipped the last check in order to just print the calculated value after passing <code>123</code> as last argument:</p>
<pre tabindex="0"><code>[0x00400508]&gt; dr x0 = 0x0 # Set register value to the expected value
[0x00400508]&gt; dc
ok,ok! you are not a baby r2 reverser!
The key to be a g00d reverser is: r2con{c0ffe7}
</code></pre><p>So it seems pretty obvious that the correct flag has to be <code>r2con{c0ffee}</code>.</p>
<h1 id="land-of-ecodelia">Land of Ecodelia</h1>
<p>This is a text based adventure that prints the flag after answering all questions correctly. In fact, the string</p>
<pre tabindex="0"><code>The flag is r2con2019{all_your_answers_in_order_without_spaces}
</code></pre><p>is even embedded in the binary.</p>
<p>Let&rsquo;s check out some functions:</p>
<ul>
<li><code>sym.go.main.main</code>: This function reads user input and calls the following two functions.</li>
<li><code>sym.go.main.encode</code>: This &ldquo;encodes&rdquo; the user input and returns it.</li>
<li><code>sym.go.main.check</code>: This compares the user input with the expected value. The application aborts in case the two values don&rsquo;t match.</li>
</ul>
<p>What&rsquo;s really happening in the <code>sym.go.main.encode</code> function is that it uses an embedded key to XOR encrypt the input:</p>
<pre tabindex="0"><code>0x0048a32b      0fb61416       movzx edx, byte [rsi + rdx]
0x0048a32f      4131d2         xor r10d, edx
</code></pre><p>The <code>RSI</code> register points to the key and <code>RDX</code> is the current offset in the key. It&rsquo;s important to note that for each question an individual key is being used. The keys are defined here:</p>
<p><img src="/img/r2ctf-2019/ecodelia-keys.jpg" alt="Ecodelia"></p>
<p>The look as if they were the answers to the questions but they are not :)</p>
<p>The <code>check()</code> function performs two checks:</p>
<ol>
<li>Check whether the length of both strings match</li>
<li>Compare the values byte by byte:</li>
</ol>
<pre tabindex="0"><code>0x0048a485      0fb6341a       movzx esi, byte [rdx + rbx] # Value A
0x0048a489      0fb63c19       movzx edi, byte [rcx + rbx] # Value B
0x0048a48d      4038fe         cmp sil, dil # CMP RSI, RDI
</code></pre><p>My solution was to:</p>
<ol>
<li>Set a breakpoint in the <code>encode()</code> function before the key is being used (<code>0x0048a32b</code>).</li>
<li>Read the currently used key with <code>pxq@rsi</code></li>
<li>Set a breakpoint in <code>check()</code> at <code>0x0048a46a</code> (length check) and <code>0x0048a48d</code> (comparing).</li>
<li>Skip the length check by writing the expected value to the register.</li>
<li>Read the expected value from the register, again with <code>pxq</code>.</li>
<li>Use CyberChef to decrypt the expected value using the current key:</li>
</ol>
<p><img src="/img/r2ctf-2019/ecodelia-decrypt.jpg" alt="Ecodelia"></p>
<p>I&rsquo;ve performed these steps for every question. I&rsquo;m sure there are more elegant solutions but it worked anyway :D</p>
<p><img src="/img/r2ctf-2019/ecodelia-flag.jpg" alt="Ecodelia"></p>
<h1 id="r2darling">r2darling</h1>
<p>You need to enter the correct password in order to print the flag. While checking out <code>main()</code>, this caught my attention:</p>
<pre tabindex="0"><code>0x00401de0      b820000000     mov eax, 0x20
0x00401de5      89c2           mov edx, eax
0x00401de7      488b7de8       mov rdi, qword [var_18h]
0x00401deb      488b3425f850.  mov rsi, qword [obj.pass] # &lt;-- pass looks good
0x00401df3      e878f2ffff     call 0x401070 # String compare
0x00401df8      83f800         cmp eax, 0
0x00401dfb      0f8529000000   jne 0x401e2a # Not correct
</code></pre><p>The obvious thing to do is to print the value of <code>obj.pass</code> as soon as its loaded into <code>RSI</code>:</p>
<pre tabindex="0"><code>0x004a5120  0x705f746572633373  0x535f656b416b6e61   s3cret_pankAke_S
0x004a5130  0x0000002133637534  0x0000000000000000   4uc3!
</code></pre><p>I&rsquo;ve tried to submit this as a flag but nope. However, after using this string as input for the application, the correct flag can be read while executing the string comparison function listed above (<code>0x401070</code>).</p>
<pre tabindex="0"><code>[0x0041eb5a]&gt; pdf
[...]
0x0041eb52      0fb60417       movzx eax, byte [rdi + rdx]
0x0041eb56      0fb61416       movzx edx, byte [rsi + rdx]
0x0041eb5a      29d0           sub eax, edx
[...]
[0x0041eb5a]&gt; pxq@rdi
0x01bcab40  0x74316e756d4d3063  0x7234643472333c79   c0Mmun1ty&lt;3r4d4r
0x01bcab50  0x031000216e306333  0x5218046e1a101f2e   3c0n!.......n..R
</code></pre><h1 id="cerberus">Cerberus</h1>
<p>Connecting to this challenge drops the user into a pseudo shell. The <code>help</code> function prints these commands:</p>
<pre tabindex="0"><code>$help
Available commands:
* cat echo env exit help ls set unset login
</code></pre><p>After trying to log in, I&rsquo;ve found that the <code>fcn.00402600</code> function performs the login checks:</p>
<pre tabindex="0"><code>[0x004027e9]&gt; izzq~DENIED
0x406197 15 14 ACCESS DENIED\n
[0x004027e9]&gt; axt 0x406197
fcn.00402600 0x4027c7 [DATA] movabs rdi, str.ACCESS_DENIED
</code></pre><p>I&rsquo;ve pulled the correct login credentials directly from memory by setting a breakpoint before the string comparison function:</p>
<p><img src="/img/r2ctf-2019/cerberus-dbg1.jpg" alt="Cerberus"></p>
<p>The correct user name is <code>an0nym0us</code> and the password is <code>Intrud3r</code>. After logging in, there&rsquo;s a file present called <code>flag.txt</code> but it can&rsquo;t be read by the current user. After executing <code>env</code> it shows that there&rsquo;s an environment variable present called <code>ADMIN</code> with no value set.</p>
<p>I decided to search for this string in the whole process memory and found two interesting things:</p>
<p>First, there seems to be an additional <code>su</code> command that isn&rsquo;t printed by the help function:</p>
<pre tabindex="0"><code>0x004081a0  0x7461630074697865  0x6e65006f68636500   exit.cat.echo.en
0x004081b0  0x6c00706c65680076  0x6e75007465730073   v.help.ls.set.un
0x004081c0  0x69676f6c00746573  0x007325007573006e   set.login.su.%s.
0x004081d0  0x286d32333b305b1b  0x7e20296e696d6461   .[0;32m(admin) ~
0x004081e0  0x0000000000002400  0x0000000000000000   .$..............
</code></pre><p>The <code>su</code> command is present in memory along with a string that looks just like an administrative shell prompt.</p>
<p>Also, setting the <code>ADMIN</code> environment variable to <code>true</code> seems to enable the admin mode:</p>
<pre tabindex="0"><code>0x00408280  0x74746547203e7e20  0x7669727020676e69    ~&gt; Getting priv
0x00408290  0x2e2e736567656c69  0x004e494d4441002e   ileges....ADMIN.
0x004082a0  0x00000a0065757274  0x0000000000000000   true............
</code></pre><p>The script to log in as administrator is therefore:</p>
<pre tabindex="0"><code>#!/usr/bin/python2.7

from pwn import *

io = remote(&#34;206.189.109.0&#34;, 1337)
print io.recvuntil(&#34;$&#34;)
io.sendline(&#34;login an0nym0us Intrud3r&#34;)
print io.recvuntil(&#34;$&#34;)
io.sendline(&#34;set ADMIN true&#34;)
print io.recvuntil(&#34;$&#34;)
io.sendline(&#34;su&#34;)
print io.recvuntil(&#34;admin&#34;)
io.interactive()
</code></pre><p>Maybe the flag can be read now:</p>
<p><img src="/img/r2ctf-2019/cerberus-noflag.jpg" alt="Cerberus"></p>
<p>Of course not. Because of maximum trollage you have to read the hidden <code>.flag.txt</code> file that isn&rsquo;t displayed after executing <code>ls</code>. Remember, <code>ls -la</code> doesn&rsquo;t work in this pseudo shell :)</p>
<p>This is the correct flag:</p>
<p><img src="/img/r2ctf-2019/cerberus-flag.jpg" alt="Cerberus"></p>
<p>Thanks for setting up this year&rsquo;s r2CTF :)</p>
</div>

    
    

    

    <h4 id="related" class="page-header">Related</h4>

     <div class="item">

    
    
    

    

    <h4><a href="/post/satisfyer/">Analysis of Satisfyer Toys: Discovering an Authentication Bypass with r2 and Frida</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/radare2"><kbd class="item-tag">radare2</kbd></a>
    
    <a href="https://bananamafia.dev/tags/r2"><kbd class="item-tag">r2</kbd></a>
    
    <a href="https://bananamafia.dev/tags/frida"><kbd class="item-tag">frida</kbd></a>
    
    <a href="https://bananamafia.dev/tags/r2frida"><kbd class="item-tag">r2frida</kbd></a>
    
    <a href="https://bananamafia.dev/tags/reverse-engineering"><kbd class="item-tag">reverse-engineering</kbd></a>
    
    <a href="https://bananamafia.dev/tags/web"><kbd class="item-tag">web</kbd></a>
    
    <a href="https://bananamafia.dev/tags/vulnerability"><kbd class="item-tag">vulnerability</kbd></a>
    

</div>
  <div class="item">

    
    
    

    

    <h4><a href="/post/hisensehax/">Haxxoring a Hisense Smart TV</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/exploitation"><kbd class="item-tag">exploitation</kbd></a>
    
    <a href="https://bananamafia.dev/tags/reverse-engineering"><kbd class="item-tag">reverse-engineering</kbd></a>
    
    <a href="https://bananamafia.dev/tags/vulnerability"><kbd class="item-tag">vulnerability</kbd></a>
    

</div>
  <div class="item">

    
    
    

    

    <h4><a href="/post/d3dhook/">Game Hacking #3: Hooking Direct3D EndScene()</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/reverse-engineering"><kbd class="item-tag">reverse-engineering</kbd></a>
    
    <a href="https://bananamafia.dev/tags/c&#43;&#43;"><kbd class="item-tag">c&#43;&#43;</kbd></a>
    
    <a href="https://bananamafia.dev/tags/binary"><kbd class="item-tag">binary</kbd></a>
    
    <a href="https://bananamafia.dev/tags/gamehacking"><kbd class="item-tag">gamehacking</kbd></a>
    
    <a href="https://bananamafia.dev/tags/hooking"><kbd class="item-tag">hooking</kbd></a>
    

</div>
 

    

</main>
<footer id="footer">
    <img style="width:42vh" src="/img/tag.png" class="alt-img" id="mafia-tag">

    <p class="copyright text-muted">

        © All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a>
    </p>
</footer>
</body>

<script>
    var footerWidth = 200;
    $(document).ready(function () {
        setWidth();
        $(window).bind("resize", setWidth);
    });

    $(window).on('load', function () {
        setWidth();
    });

    function setWidth() {
        footerWidth = $("main").width();

        $("#footer").css("min-width", (footerWidth > 300 ? footerWidth : 300) + "px");
        
    }

    $(window).on('resize', function () {
        setWidth();
    });

</script>

</html>


<script>
    var width = 200;
    $(document).ready(function () {
        setMaxWidth();
        $(window).bind("resize", setMaxWidth);
    });


    function setMaxWidth() {
        $("pre > code").css("display", "none");
        $("pre").css("display", "none");

        width = $("#related").width();

        $("pre > code").css("display", "block");
        $("pre").css("display", "block");

        $("pre > code").css("maxWidth", (width) + "px");
        $("pre").css("maxWidth", (width) + "px");
    }

    $(window).on('resize', function () {
        setMaxWidth();
    });

    $(window).on('load', function () {
        setMaxWidth();
    });



</script>