<!DOCTYPE html>
<html lang="en-us">

<head>
     
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Exploiting Unquoted Service Paths For Fun and No Profit</title>
    <style>

    html body {
        font-family: 'Raleway', sans-serif;
        background-color: white;
    }

    :root {
        --accent: #ffe135;
        --border-width:  5px ;
    }

</style>





<link rel="stylesheet" href="https://bananamafia.dev//css/font.css">


 <link rel="stylesheet" href="https://bananamafia.dev//css/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://bananamafia.dev//css/bootstrap-min.css" integrity="">


<link rel="stylesheet" href="https://bananamafia.dev//css/main.css">


<link rel="stylesheet" href="https://bananamafia.dev//css/font-awesome.min.css" integrity="">
 


<script src="https://bananamafia.dev/js/highlight.min.js"></script>


<script src="https://bananamafia.dev/js/python.min.js"></script> 
<script src="https://bananamafia.dev/js/cpp.min.js"></script> 
<script src="https://bananamafia.dev/js/json.min.js"></script> 
<script src="https://bananamafia.dev/js/go.min.js"></script> 

<script>
  hljs.initHighlightingOnLoad();
</script>




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-143157939-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-143157939-1');
</script>





















<script src="https://bananamafia.dev/js/jquery.min.js"></script>


<script src="https://bananamafia.dev/js/bootstrap.min.js"></script>


<script>$(document).on('click', function () { $('.collapse').collapse('hide'); })</script>


 <meta name="generator" content="Hugo 0.70.0" />
    

    
</head>




<body>
     
    <nav class="navbar navbar-default navbar-fixed-top">

        <div class="container">

            <div class="navbar-header">

                <a class="navbar-brand visible-xs" href="#">Exploiting Unquoted Service Paths For Fun and No Profit</a>

                <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

            </div>

            <div class="collapse navbar-collapse">

                
                <ul class="nav navbar-nav">
                    
                    <li><a href="/">Home</a></li>
                    
                    <li><a href="/post/">Posts</a></li>
                    
                    <li><a href="/project/">Projects</a></li>
                    
                </ul>
                

                
                <ul class="nav navbar-nav navbar-right">
                    
                    <li class="navbar-icon"><a href="mailto:banana@bananamafia.dev"><i class="fa fa-envelope-o"></i></a></li>
                    
                    <li class="navbar-icon"><a href="https://github.com/ps1337/"><i class="fa fa-github"></i></a></li>
                    
                    <li class="navbar-icon"><a href="https://twitter.com/CaptnBanana"><i class="fa fa-twitter"></i></a></li>
                    
                    <li class="navbar-icon"><a href="/index.xml"><i class="fa fa-rss"></i></a></li>
                    
                    <li class="navbar-icon"><a href="https://www.youtube.com/watch?v=ao2GL3NAWQU"><i class="fa fa-envira"></i></a></li>
                    
                    <li class="navbar-icon"><a href=""><i class="fa fa-adjust"></i></a></li>
                    
                </ul>
                

            </div>

        </div>

    </nav>


    <script>
        
        $(".fa-adjust").parent().removeAttr("href");

        
        window.onload = setMode();

        function setMode() {
            const currentTheme = localStorage.getItem('bananamafia_theme') ? localStorage.getItem('bananamafia_theme') : null;

            if (currentTheme == "light" || currentTheme == null) {
                setLight();
            }
            else {
                setDark();
            }
        }

        function setDark() {
            document.documentElement.setAttribute('data-theme', 'dark');
            localStorage.setItem('bananamafia_theme', 'dark');
        }

        function setLight() {
            document.documentElement.setAttribute('data-theme', 'light');
            localStorage.setItem('bananamafia_theme', 'light');
        }

        $(".fa-adjust").on("click", function () {
            const currentTheme = localStorage.getItem('bananamafia_theme') ? localStorage.getItem('bananamafia_theme') : null;
            $("body").addClass("transition-bg");
            $("nav").addClass("transition-bg");
            if (currentTheme == "dark") {
                setLight();
            } else {
                setDark();
            }

            setTimeout(function () {
                $("body").removeClass("transition-bg");
                $("nav").removeClass("transition-bg");
            }, 500);

        });
    </script>

<main id="main">

    <div class="item">

    
    
    

    

    <h4><a href="/post/realtek-driverutil/">Exploiting Unquoted Service Paths For Fun and No Profit</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/exploitation"><kbd class="item-tag">exploitation</kbd></a>
    
    <a href="https://bananamafia.dev/tags/cve"><kbd class="item-tag">cve</kbd></a>
    
    <a href="https://bananamafia.dev/tags/windows"><kbd class="item-tag">windows</kbd></a>
    

</div>


    <br>
    <div class="content-width text-justify"><p>This kind of vulnerability is really old. However, vendors still fail to properly address this issue. This is just another example of exploiting this kind of vulnerability on Windows 10 with the most up-to-date ALFA AWUS036AC driver utility (version <code>1030.6</code>). Note that the <a href="https://www.alfa.com.tw/files/?dir=USB%20Driver/Windows/AWUS036AC">download link</a> points to <code>alfa.com</code> but the driver utility itself says it&rsquo;s developed by REALTEK.</p>
<h1 id="the-vulnerability">The vulnerability</h1>
<p>Upon installing the driver utility, two vulnerable services get installed. This can be checked using the following <a href="https://www.commonexploits.com/unquoted-service-paths/">command</a>:</p>
<pre><code>C:\Users\ps&gt;wmic service get name,displayname,pathname,startmode |findstr /i &quot;auto&quot; |findstr /i /v &quot;c:\windows\\&quot; |findstr /i /v &quot;&quot;&quot;

Realtek DHCP Service | RTLDHCPService | C:\Program Files (x86)\REALTEK\USB Wireless LAN Utility\RTLDHCP.exe

RealtekWlanU         | RealtekWlanU   | C:\Program Files (x86)\REALTEK\USB Wireless LAN Utility\RtlService.exe
</code></pre><p>This means, that the service paths of both services, called <code>Realtek DHCP Service</code> and <code>RealtekWlanU</code>, contain spaces and are <strong>not</strong> quoted using <code>&quot;</code>. Therefore, they are vulnerable to this kind of attack.</p>
<p>A quick C++ <a href="https://github.com/ps1337/getuser">PoC</a> that logs the username of the user that executes a certain <code>.exe</code> file looks like this:</p>
<pre><code>char username[UNLEN+1];
DWORD username_len = UNLEN+1;
GetUserName(username, &amp;username_len);

std::ofstream outfile;
outfile.open(&quot;C:\\Users\\Public\\userlog.txt&quot;, std::ios_base::app);
outfile &lt;&lt; username &lt;&lt; std::endl;
</code></pre><p>When executed as a regular user, the binary outputs <code>ps</code>, being a regular user account.</p>
<h1 id="the-exploit">The Exploit</h1>
<p>Both service paths share the common string <code>C:\Program Files (x86)\REALTEK\USB Wireless LAN Utility</code>. Note that the substring <code>USB Wireless LAN Utility</code> contains spaces, which is a part of the vulnerability. Exploiting this works by placing a malicious file called <code>USB.exe</code> into <code>C:\Program Files (x86)\REALTEK</code>, making the full path <code>C:\Program Files (x86)\REALTEK\USB.exe</code>. Please not that this can only be performed by administrators <strong>in this case</strong>. So this will get you a privilege ecscalation from <code>Administrator</code> to <code>SYSTEM</code> ¯\<em>(ツ)</em>/¯. The binary supplied by an attacker will be executed as <code>SYSTEM</code> upon restarting the system. This can be seen for both vulnerable services in the log file:</p>
<pre><code>SYSTEM
SYSTEM
</code></pre><h1 id="the-cause">The cause</h1>
<p>The string which specifies the service path needs to be quoted to prevent this, as seen in <a href="https://www.commonexploits.com/unquoted-service-paths/">this example</a></p>
<h1 id="additional-note">Additional note</h1>
<p>While quickly testing this for multiple driver utilities by REALTEK, all tested packages seemed to be &ldquo;vulnerable&rdquo;.</p>
<h1 id="credits">Credits</h1>
<ul>
<li><a href="https://www.commonexploits.com/unquoted-service-paths/">Common Exploits</a> for the cmd command.</li>
</ul>
</div>

    
    

    

    <h4 id="related" class="page-header">Related</h4>

     <div class="item">

    
    
    

    

    <h4><a href="/post/srop/">SROP Exploitation with radare2</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/r2"><kbd class="item-tag">r2</kbd></a>
    
    <a href="https://bananamafia.dev/tags/radare2"><kbd class="item-tag">radare2</kbd></a>
    
    <a href="https://bananamafia.dev/tags/rop"><kbd class="item-tag">rop</kbd></a>
    
    <a href="https://bananamafia.dev/tags/exploitation"><kbd class="item-tag">exploitation</kbd></a>
    
    <a href="https://bananamafia.dev/tags/ctf"><kbd class="item-tag">ctf</kbd></a>
    

</div>
  <div class="item">

    
    
    

    

    <h4><a href="/post/gb-fuzz/">Fuzzing A GameBoy Emulator With AFL&#43;&#43;</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/fuzzing"><kbd class="item-tag">fuzzing</kbd></a>
    
    <a href="https://bananamafia.dev/tags/reversing"><kbd class="item-tag">reversing</kbd></a>
    
    <a href="https://bananamafia.dev/tags/exploitation"><kbd class="item-tag">exploitation</kbd></a>
    

</div>
  <div class="item">

    
    
    

    

    <h4><a href="/post/uaf-1/">Exploiting A Use-After-Free With radare2 - CTF Challenge</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/ctf"><kbd class="item-tag">ctf</kbd></a>
    
    <a href="https://bananamafia.dev/tags/reversing"><kbd class="item-tag">reversing</kbd></a>
    
    <a href="https://bananamafia.dev/tags/exploitation"><kbd class="item-tag">exploitation</kbd></a>
    
    <a href="https://bananamafia.dev/tags/r2"><kbd class="item-tag">r2</kbd></a>
    
    <a href="https://bananamafia.dev/tags/radare2"><kbd class="item-tag">radare2</kbd></a>
    
    <a href="https://bananamafia.dev/tags/cutter"><kbd class="item-tag">cutter</kbd></a>
    
    <a href="https://bananamafia.dev/tags/heap"><kbd class="item-tag">heap</kbd></a>
    

</div>
 

    

</main>
<footer id="footer">
    <img style="width:42vh" src="/img/tag.png">

    <p class="copyright text-muted">

        © All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a>
    </p>
</footer>
</body>

<script>
    var footerWidth = 200;
    $(document).ready(function () {
        setWidth();
        $(window).bind("resize", setWidth);
    });

    $(window).on('load', function () {
        setWidth();
    });

    function setWidth() {
        footerWidth = $("main").width();

        $("#footer").css("min-width", (footerWidth > 300 ? footerWidth : 300) + "px");
        
    }

    $(window).on('resize', function () {
        setWidth();
    });

</script>

</html>


<script>
    var width = 200;
    $(document).ready(function () {
        setMaxWidth();
        $(window).bind("resize", setMaxWidth);
    });


    function setMaxWidth() {
        $("pre > code").css("display", "none");
        $("pre").css("display", "none");

        width = $("#related").width();

        $("pre > code").css("display", "block");
        $("pre").css("display", "block");

        $("pre > code").css("maxWidth", (width) + "px");
        $("pre").css("maxWidth", (width) + "px");
    }

    $(window).on('resize', function () {
        setMaxWidth();
    });

    $(window).on('load', function () {
        setMaxWidth();
    });



</script>