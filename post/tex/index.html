<!DOCTYPE html>
<html lang="en-us">

<head>
     
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Command Injection in LaTeX Workshop</title>
    <style>

    html body {
        font-family: 'Raleway', sans-serif;
        background-color: white;
    }

    :root {
        --border-width:  5px ;
    }

</style>





<link rel="stylesheet" href="https://bananamafia.dev//css/font.css">


 <link rel="stylesheet" href="https://bananamafia.dev//css/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://bananamafia.dev//css/bootstrap-min.css" integrity="">


<link rel="stylesheet" href="https://bananamafia.dev//css/main.css">


<link rel="stylesheet" href="https://bananamafia.dev//css/font-awesome.min.css" integrity="">

 


<script src="/js/highlight.min.js"></script>


<script src="/js/python.min.js"></script> 
<script src="/js/cpp.min.js"></script> 
<script src="/js/json.min.js"></script> 
<script src="/js/go.min.js"></script> 

<script>
  hljs.initHighlightingOnLoad();
</script>




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-143157939-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-143157939-1');
</script>





















<script src="/js/jquery.min.js"></script>


<script src="/js/bootstrap.min.js"></script>


<script>$(document).on('click', function () { $('.collapse').collapse('hide'); })</script>


<script src="/js/confetti.browser.js"></script> <meta name="generator" content="Hugo 0.81.0" />
    

    
</head>




<body>
     
    <nav class="navbar navbar-default navbar-fixed-top">

        <div class="container">

            <div class="navbar-header">

                <a class="navbar-brand visible-xs" href="#">Command Injection in LaTeX Workshop</a>

                <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

            </div>

            <div class="collapse navbar-collapse">

                
                <ul class="nav navbar-nav">
                    
                    <li><a href="/">Home</a></li>
                    
                    <li><a href="/post/">Posts</a></li>
                    
                    <li><a href="/project/">Projects</a></li>
                    
                </ul>
                

                
                <ul class="nav navbar-nav navbar-right">
                    
                    <li class="navbar-icon"><a href="mailto:banana-#@#-bananamafia.dev"><i class="fa fa-envelope-o"></i></a></li>
                    
                    <li class="navbar-icon"><a href="https://github.com/ps1337/"><i class="fa fa-github"></i></a></li>
                    
                    <li class="navbar-icon"><a href="https://twitter.com/CaptnBanana"><i class="fa fa-twitter"></i></a></li>
                    
                    <li class="navbar-icon"><a href="/index.xml"><i class="fa fa-rss"></i></a></li>
                    
                    <li class="navbar-icon"><a href=""><i class="fa fa-toggle-off"></i></a></li>
                    
                    <li class="navbar-icon"><a href="https://www.youtube.com/watch?v=ao2GL3NAWQU"><i class="fa fa-envira"></i></a></li>
                    
                </ul>
                

            </div>

        </div>

    </nav>


    <script>
        
        
        

        
        $(".fa-toggle-off, .fa-toggle-on").parent().removeAttr("href");

        
        window.onload = setMode();

        function isLightMode() {

            const currentTheme = localStorage.getItem('bananamafia_theme') ? localStorage.getItem('bananamafia_theme') : null;

            if (currentTheme == "light" || currentTheme == null) {
                return true;
            }
            else {
                return false;
            }
        }

        function setMode() {
            if (isLightMode()) {
                setLight();
            }
            else {
                setDark();
            }
        }

        function setDark() {
            document.documentElement.setAttribute('data-theme', 'dark');
            localStorage.setItem('bananamafia_theme', 'dark');

            $(".fa-toggle-off").each(function (i) {
                $(this).removeClass("fa-toggle-off");
                $(this).addClass("fa-toggle-on");
            });
            setAltImgs();
        }

        function setLight() {
            document.documentElement.setAttribute('data-theme', 'light');
            localStorage.setItem('bananamafia_theme', 'light');

            $(".fa-toggle-on").each(function (i) {
                $(this).removeClass("fa-toggle-on");
                $(this).addClass("fa-toggle-off");
            });
            setAltImgs();
        }

        function setAltImgs() {
            var lightMode = isLightMode();
            $(".alt-img").each(function (idx) {
                if (lightMode) {
                    
                    var newSrc = $(this).attr("src").replace("_dark", "");
                }
                else {
                    
                    var imgExt = $(this).attr("src").split(".").pop();
                    var newSrc = $(this).attr("src").substr(0, $(this).attr("src").lastIndexOf(".")) + "_dark." + imgExt;
                }

                $(this).fadeOut(250, function () {
                    $(this).attr("src", newSrc);
                });
                $(this).fadeIn(250);
            });
        }

        $(".fa-toggle-off, .fa-toggle-on").on("click", function () {
            const currentTheme = localStorage.getItem('bananamafia_theme') ? localStorage.getItem('bananamafia_theme') : null;
            $("body").addClass("transition-bg");
            $("nav").addClass("transition-bg");
            if (currentTheme == "dark") {
                setLight();
            } else {
                setDark();
            }

            setTimeout(function () {
                $("body").removeClass("transition-bg");
                $("nav").removeClass("transition-bg");
            }, 500);

        });

        $(document).ready(function () {
            
            $(".fa-envira").parent().mouseenter(function () {
                confetti.reset();

                confetti({
                    useWorker: true,
                    particleCount: 200,
                    angle: 90,
                    spread: 70,
                    origin: {
                        x: 0.5, y: 1
                    },
                    startVelocity: 60
                });
            });
            setAltImgs();
        });
    </script>


<main id="main">

    <div class="item">

    
    
    

    

    <h4><a href="/post/tex/">Command Injection in LaTeX Workshop</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/exploitation"><kbd class="item-tag">exploitation</kbd></a>
    
    <a href="https://bananamafia.dev/tags/vulnerability"><kbd class="item-tag">vulnerability</kbd></a>
    

</div>


    <br>
    <div class="content-width text-justify"><p>Welcome to another round of <em>Banana tweets and unintentionally makes people mad</em>.</p>
<p>I&rsquo;ve had a look at some VS Code extensions that make use of shell commands with the goal to find a command injection vulnerability. For this, I&rsquo;ve grepped for <code>child_process</code>, since this is a <a href="https://nodejs.org/api/child_process.html">NodeJS API</a> that&rsquo;s commonly used to execute shell commands in VS Code.</p>
<p>I&rsquo;ve quickly found various extensions that make use of this API. A vulnerability exists in case:</p>
<ol>
<li>A part of the shell command is user-controlled.</li>
<li>No filtering or shell escaping is applied to user input.</li>
</ol>
<p>This means that not every usage of <code>child_process</code> is problematic. However, I&rsquo;ve found one flaw of this kind in <a href="https://marketplace.visualstudio.com/items?itemName=James-Yu.latex-workshop">LaTeX Workshop</a> which currently has over 1.1 million installs.</p>
<p>The extension adds <a href="https://code.visualstudio.com/docs/editor/intellisense">Intellisense</a> features for LaTeX to VS Code. One part of this feature involves suggestions for names of files that are present in the current project directory. Not every file name should be a part of the generated suggestions, since files could be ignored via <code>git</code>. This function takes care of the filtering task:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">[...]
<span style="color:#66d9ef">import</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">cp</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;child_process&#39;</span>
[...]
<span style="color:#66d9ef">private</span> <span style="color:#a6e22e">filterIgnoredFiles</span>(<span style="color:#a6e22e">files</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>[], <span style="color:#a6e22e">baseDir</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>[] {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">excludeGlob</span> <span style="color:#f92672">=</span> (Object.<span style="color:#a6e22e">keys</span>(<span style="color:#a6e22e">vscode</span>.<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">getConfiguration</span>(<span style="color:#e6db74">&#39;files&#39;</span>, <span style="color:#66d9ef">null</span>).<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;exclude&#39;</span>) <span style="color:#f92672">||</span> {})).<span style="color:#a6e22e">concat</span>(<span style="color:#a6e22e">vscode</span>.<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">getConfiguration</span>(<span style="color:#e6db74">&#39;latex-workshop&#39;</span>).<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;intellisense.file.exclude&#39;</span>) <span style="color:#f92672">||</span> [] ).<span style="color:#a6e22e">concat</span>(<span style="color:#a6e22e">ignoreFiles</span>)
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">gitIgnoredFiles</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>[] <span style="color:#f92672">=</span> []
    <span style="color:#75715e">/* Check .gitignore if needed */</span>
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">vscode</span>.<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">getConfiguration</span>(<span style="color:#e6db74">&#39;search&#39;</span>, <span style="color:#66d9ef">null</span>).<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;useIgnoreFiles&#39;</span>)) {
        <span style="color:#66d9ef">try</span> {
            <span style="color:#75715e">/* OSX pops up a dialog box to install `git` when it is not available.
</span><span style="color:#75715e">            The `which` command exits with a non-zero return code when `git` is not found,
</span><span style="color:#75715e">            which makes `execSync` throw an error */</span>
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">platform</span>() <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;darwin&#39;</span>) {
                <span style="color:#a6e22e">cp</span>.<span style="color:#a6e22e">execSync</span>(<span style="color:#e6db74">&#39;which git&#39;</span>)
            }
            <span style="color:#a6e22e">gitIgnoredFiles</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">cp</span>.<span style="color:#a6e22e">execSync</span>(<span style="color:#e6db74">&#39;git check-ignore &#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">files</span>.<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39; &#39;</span>), {<span style="color:#a6e22e">cwd</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">baseDir</span>})).<span style="color:#a6e22e">toString</span>().<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;\n&#39;</span>)
        } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">ex</span>) { }
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">files</span>.<span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">file</span> =&gt; {
        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">filePath</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">baseDir</span>, <span style="color:#a6e22e">file</span>)
        <span style="color:#75715e">/* Check if the file should be ignored */</span>
        <span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">gitIgnoredFiles</span>.<span style="color:#a6e22e">includes</span>(<span style="color:#a6e22e">file</span>)) <span style="color:#f92672">||</span> <span style="color:#a6e22e">micromatch</span>.<span style="color:#a6e22e">any</span>(<span style="color:#a6e22e">filePath</span>, <span style="color:#a6e22e">excludeGlob</span>, {<span style="color:#a6e22e">basename</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>})) {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
        }
    })
}
</code></pre></div><p>As can be seen, <code>git check-ignore</code> gets called with a list of file names to perform this check. The issue here is that the value of <code>files.join(' ')</code> is not escaped before being passed to <code>execSync()</code>, which is the API to execute a shell command.</p>
<p>Now, imagine downloading a LaTeX template and editing it with this extension. There could be a hidden file with the name <code>.`sleep 1337`</code>, which causes the shell command to be <code>git check-ignore .`sleep 1337`</code>. This triggers a command injection as soon as Intellisense for file names is triggered:</p>
<p><img src="/img/tex/tex.gif" alt="tex hax"></p>
<p>Until a fix is available, disabling <code>search.useIgnoreFiles</code> should prevent the exploit from succeeding.</p>
<br>
<marquee><b>That's all.</b></marquee></div>

    
    

    

    <h4 id="related" class="page-header">Related</h4>

     <div class="item">

    
    
    

    

    <h4><a href="/post/hisensehax/">Haxxoring a Hisense Smart TV</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/exploitation"><kbd class="item-tag">exploitation</kbd></a>
    
    <a href="https://bananamafia.dev/tags/reverse-engineering"><kbd class="item-tag">reverse-engineering</kbd></a>
    
    <a href="https://bananamafia.dev/tags/vulnerability"><kbd class="item-tag">vulnerability</kbd></a>
    

</div>
  <div class="item">

    
    
    

    

    <h4><a href="/post/srop/">SROP Exploitation with radare2</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/r2"><kbd class="item-tag">r2</kbd></a>
    
    <a href="https://bananamafia.dev/tags/radare2"><kbd class="item-tag">radare2</kbd></a>
    
    <a href="https://bananamafia.dev/tags/rop"><kbd class="item-tag">rop</kbd></a>
    
    <a href="https://bananamafia.dev/tags/exploitation"><kbd class="item-tag">exploitation</kbd></a>
    
    <a href="https://bananamafia.dev/tags/ctf"><kbd class="item-tag">ctf</kbd></a>
    

</div>
  <div class="item">

    
    
    

    

    <h4><a href="/post/gb-fuzz/">Fuzzing A GameBoy Emulator With AFL&#43;&#43;</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/fuzzing"><kbd class="item-tag">fuzzing</kbd></a>
    
    <a href="https://bananamafia.dev/tags/reversing"><kbd class="item-tag">reversing</kbd></a>
    
    <a href="https://bananamafia.dev/tags/exploitation"><kbd class="item-tag">exploitation</kbd></a>
    

</div>
 

    

</main>
<footer id="footer">
    <img style="width:42vh" src="/img/tag.png" class="alt-img" id="mafia-tag">

    <p class="copyright text-muted">

        © All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a>
    </p>
</footer>
</body>

<script>
    var footerWidth = 200;
    $(document).ready(function () {
        setWidth();
        $(window).bind("resize", setWidth);
    });

    $(window).on('load', function () {
        setWidth();
    });

    function setWidth() {
        footerWidth = $("main").width();

        $("#footer").css("min-width", (footerWidth > 300 ? footerWidth : 300) + "px");
        
    }

    $(window).on('resize', function () {
        setWidth();
    });

</script>

</html>


<script>
    var width = 200;
    $(document).ready(function () {
        setMaxWidth();
        $(window).bind("resize", setMaxWidth);
    });


    function setMaxWidth() {
        $("pre > code").css("display", "none");
        $("pre").css("display", "none");

        width = $("#related").width();

        $("pre > code").css("display", "block");
        $("pre").css("display", "block");

        $("pre > code").css("maxWidth", (width) + "px");
        $("pre").css("maxWidth", (width) + "px");
    }

    $(window).on('resize', function () {
        setMaxWidth();
    });

    $(window).on('load', function () {
        setMaxWidth();
    });



</script>