<!DOCTYPE html>
<html lang="en-us">

<head>
     
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Reversing .NET Applications: CCCamp19 CTF CampRE Challenge</title>
    <style>

    html body {
        font-family: 'Raleway', sans-serif;
        background-color: white;
    }

    :root {
        --border-width:  5px ;
    }

</style>





<link rel="stylesheet" href="https://bananamafia.dev//css/font.css">


 <link rel="stylesheet" href="https://bananamafia.dev//css/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://bananamafia.dev//css/bootstrap-min.css" integrity="">


<link rel="stylesheet" href="https://bananamafia.dev//css/main.css">


<link rel="stylesheet" href="https://bananamafia.dev//css/font-awesome.min.css" integrity="">

 


<script src="/js/highlight.min.js"></script>


<script src="/js/python.min.js"></script> 
<script src="/js/cpp.min.js"></script> 
<script src="/js/json.min.js"></script> 
<script src="/js/go.min.js"></script> 

<script>
  hljs.initHighlightingOnLoad();
</script>




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-143157939-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-143157939-1');
</script>





















<script src="/js/jquery.min.js"></script>


<script src="/js/bootstrap.min.js"></script>


<script>$(document).on('click', function () { $('.collapse').collapse('hide'); })</script>


<script src="/js/confetti.browser.js"></script> <meta name="generator" content="Hugo 0.73.0" />
    

    
</head>




<body>
     
    <nav class="navbar navbar-default navbar-fixed-top">

        <div class="container">

            <div class="navbar-header">

                <a class="navbar-brand visible-xs" href="#">Reversing .NET Applications: CCCamp19 CTF CampRE Challenge</a>

                <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

            </div>

            <div class="collapse navbar-collapse">

                
                <ul class="nav navbar-nav">
                    
                    <li><a href="/">Home</a></li>
                    
                    <li><a href="/post/">Posts</a></li>
                    
                    <li><a href="/project/">Projects</a></li>
                    
                </ul>
                

                
                <ul class="nav navbar-nav navbar-right">
                    
                    <li class="navbar-icon"><a href="mailto:banana@bananamafia.dev"><i class="fa fa-envelope-o"></i></a></li>
                    
                    <li class="navbar-icon"><a href="https://github.com/ps1337/"><i class="fa fa-github"></i></a></li>
                    
                    <li class="navbar-icon"><a href="https://twitter.com/CaptnBanana"><i class="fa fa-twitter"></i></a></li>
                    
                    <li class="navbar-icon"><a href="/index.xml"><i class="fa fa-rss"></i></a></li>
                    
                    <li class="navbar-icon"><a href=""><i class="fa fa-toggle-off"></i></a></li>
                    
                    <li class="navbar-icon"><a href="https://www.youtube.com/watch?v=ao2GL3NAWQU"><i class="fa fa-envira"></i></a></li>
                    
                    <li class="navbar-icon"><a href="https://www.paypal.com/cgi-bin/webscr?cmd=_donations&amp;business=banana@bananamafia.dev&amp;item_name=Buy&#43;Me&#43;A&#43;Banana&amp;no_note=0&amp;cn=&amp;currency_code=EUR&amp;bn=PP-DonationsBF:btn_donateCC_LG.gif:NonHosted"><i class="fa fa-money"></i></a></li>
                    
                </ul>
                

            </div>

        </div>

    </nav>


    <script>
        
        
        

        
        $(".fa-toggle-off, .fa-toggle-on").parent().removeAttr("href");

        
        window.onload = setMode();

        function isLightMode() {

            const currentTheme = localStorage.getItem('bananamafia_theme') ? localStorage.getItem('bananamafia_theme') : null;

            if (currentTheme == "light" || currentTheme == null) {
                return true;
            }
            else {
                return false;
            }
        }

        function setMode() {
            if (isLightMode()) {
                setLight();
            }
            else {
                setDark();
            }
        }

        function setDark() {
            document.documentElement.setAttribute('data-theme', 'dark');
            localStorage.setItem('bananamafia_theme', 'dark');

            $(".fa-toggle-off").each(function (i) {
                $(this).removeClass("fa-toggle-off");
                $(this).addClass("fa-toggle-on");
            });
            setAltImgs();
        }

        function setLight() {
            document.documentElement.setAttribute('data-theme', 'light');
            localStorage.setItem('bananamafia_theme', 'light');

            $(".fa-toggle-on").each(function (i) {
                $(this).removeClass("fa-toggle-on");
                $(this).addClass("fa-toggle-off");
            });
            setAltImgs();
        }

        function setAltImgs() {
            var lightMode = isLightMode();
            $(".alt-img").each(function (idx) {
                if (lightMode) {
                    
                    var newSrc = $(this).attr("src").replace("_dark", "");
                }
                else {
                    
                    var imgExt = $(this).attr("src").split(".").pop();
                    var newSrc = $(this).attr("src").substr(0, $(this).attr("src").lastIndexOf(".")) + "_dark." + imgExt;
                }

                $(this).fadeOut(250, function () {
                    $(this).attr("src", newSrc);
                });
                $(this).fadeIn(250);
            });
        }

        $(".fa-toggle-off, .fa-toggle-on").on("click", function () {
            const currentTheme = localStorage.getItem('bananamafia_theme') ? localStorage.getItem('bananamafia_theme') : null;
            $("body").addClass("transition-bg");
            $("nav").addClass("transition-bg");
            if (currentTheme == "dark") {
                setLight();
            } else {
                setDark();
            }

            setTimeout(function () {
                $("body").removeClass("transition-bg");
                $("nav").removeClass("transition-bg");
            }, 500);

        });

        $(document).ready(function () {
            
            $(".fa-money").parent().mouseenter(function () {
                confetti.reset();

                confetti({
                    useWorker: true,
                    particleCount: 200,
                    angle: 90,
                    spread: 70,
                    origin: {
                        x: 0.5, y: 1
                    },
                    startVelocity: 60
                });
            });
            setAltImgs();
        });
    </script>

<main id="main">

    <div class="item">

    
    
    

    

    <h4><a href="/post/dotnet-re-cccamp19/">Reversing .NET Applications: CCCamp19 CTF CampRE Challenge</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/ctf"><kbd class="item-tag">ctf</kbd></a>
    
    <a href="https://bananamafia.dev/tags/dotnet"><kbd class="item-tag">dotnet</kbd></a>
    
    <a href="https://bananamafia.dev/tags/reverse-engineering"><kbd class="item-tag">reverse-engineering</kbd></a>
    

</div>


    <br>
    <div class="content-width text-justify"><p>Finally a nice .NET CTF challenge - time to pull out <a href="https://github.com/0xd4d/dnSpy">dnSpy</a> :)</p>
<p>The provided ZIP includes a <code>CampRE.dll</code> file which, according to the challenge description, is a .NET Core application. Time to boot a Windows VM and install the .NET Core runtime environment.</p>
<p>After decompiling the <code>dll</code>, this source code can be inspected:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
{
    <span style="color:#66d9ef">byte</span>[] sourceArray = File.ReadAllBytes(Assembly.GetAssembly(<span style="color:#66d9ef">typeof</span>(Program)).Location);
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; <span style="color:#ae81ff">1333337</span>; i++)
    {
        MD5 md = MD5.Create();
        <span style="color:#66d9ef">byte</span>[] bytes = Encoding.ASCII.GetBytes(<span style="color:#e6db74">&#34;i=&#34;</span> + i.ToString());
        <span style="color:#66d9ef">byte</span>[] array = md.ComputeHash(bytes);
        MD5 md2 = MD5.Create();
        <span style="color:#66d9ef">byte</span>[] bytes2 = Encoding.ASCII.GetBytes(<span style="color:#e6db74">&#34;i1337=&#34;</span> + i.ToString());
        <span style="color:#66d9ef">byte</span>[] sourceArray2 = md2.ComputeHash(bytes2);
        <span style="color:#66d9ef">byte</span>[] destinationArray = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[<span style="color:#ae81ff">32</span>];
        Array.Copy(array, <span style="color:#ae81ff">0</span>, destinationArray, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">16</span>);
        Array.Copy(sourceArray2, <span style="color:#ae81ff">0</span>, destinationArray, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">16</span>);
        <span style="color:#66d9ef">byte</span>[] array2 = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[<span style="color:#ae81ff">16</span>];
        MD5 md3 = MD5.Create();
        <span style="color:#66d9ef">byte</span>[] array3 = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[<span style="color:#ae81ff">10</span>];
        Array.Copy(sourceArray, <span style="color:#ae81ff">4432</span>, array3, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>);
        <span style="color:#66d9ef">byte</span>[] sourceArray3 = md3.ComputeHash(array3);
        Array.Copy(sourceArray3, <span style="color:#ae81ff">0</span>, array2, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">16</span>);
        <span style="color:#66d9ef">try</span>
        {
            <span style="color:#66d9ef">global</span>::Aes aes = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">global</span>::Aes(array, array2);
            <span style="color:#66d9ef">byte</span>[] rawAssembly = aes.DecryptFromBase64StringAsByte(Program.toDecrypt);
            MethodInfo entryPoint = Assembly.Load(rawAssembly).EntryPoint;
            entryPoint.Invoke(<span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>[]
            {
                <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">string</span>[] { <span style="color:#e6db74">&#34;NOT_A_BADBOY&#34;</span> }
            });
        }
        <span style="color:#66d9ef">catch</span> (Exception ex) {}
    }
}
</code></pre></div><p>It seems that the application brute-forces the AES key for an embedded Base64 string in memory and tries to execute it as a binary afterwards. The first thing I did was modifying the <code>dll</code> with <code>dnSpy</code> in order to dump the decrypted binary to a local file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">byte</span>[] decrypted = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">global</span>::Aes(array, array2).DecryptFromBase64StringAsByte(Program.toDecrypt);
<span style="color:#75715e">// try to read some assembly info
</span><span style="color:#75715e"></span>Console.WriteLine(Assembly.Load(decrypted).FullName);
File.WriteAllBytes(<span style="color:#e6db74">&#34;Foo.dll&#34;</span>, decrypted);
</code></pre></div><p>Obviously this didn&rsquo;t work out of the box. It seems that the application reads some bytes from its own binary file in the beginning:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">byte</span>[] sourceArray = File.ReadAllBytes(Assembly.GetAssembly(<span style="color:#66d9ef">typeof</span>(Program)).Location);
<span style="color:#a6e22e">[...]</span>
Array.Copy(sourceArray, <span style="color:#ae81ff">4432</span>, array3, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>);
</code></pre></div><p>After applying the changes above, these bytes seem to be wrong since the offset changed. My second modification to the application fixes this my making the routine read the untouched file instead of its own binary:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">byte</span>[] sourceArray = File.ReadAllBytes(<span style="color:#e6db74">&#34;original.dll&#34;</span>);
</code></pre></div><p>After calling the modified binary with <code>dotnet CampRE.dll</code>, a file called <code>Foo.dll</code> has been written. Now it&rsquo;s time to decompile it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
{
    <span style="color:#66d9ef">bool</span> flag = args[<span style="color:#ae81ff">0</span>] != <span style="color:#e6db74">&#34;BADBOY&#34;</span>;
    <span style="color:#66d9ef">if</span> (flag) { Environment.Exit(-<span style="color:#ae81ff">2</span>); }

    StackTrace stackTrace = <span style="color:#66d9ef">new</span> StackTrace();
    StackFrame[] frames = stackTrace.GetFrames();
    <span style="color:#66d9ef">bool</span> flag2 = frames.Length == <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">if</span> (flag2) { Environment.Exit(-<span style="color:#ae81ff">1</span>); }
    <span style="color:#66d9ef">int</span> metadataToken = frames[<span style="color:#ae81ff">1</span>].GetMethod().MetadataToken;
    <span style="color:#66d9ef">byte</span>[] array = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[<span style="color:#ae81ff">32</span>];
    <span style="color:#66d9ef">byte</span>[] array2 = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[<span style="color:#ae81ff">16</span>];
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; <span style="color:#ae81ff">8</span>; i++)
    {
        <span style="color:#66d9ef">byte</span>[] bytes = BitConverter.GetBytes(metadataToken);
        Console.WriteLine(BitConverter.ToString(bytes));
        Array.Copy(bytes, <span style="color:#ae81ff">0</span>, array, i * <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">4</span>);
    }
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j = <span style="color:#ae81ff">0</span>; j &lt; <span style="color:#ae81ff">4</span>; j++)
    {
        <span style="color:#66d9ef">byte</span>[] bytes2 = BitConverter.GetBytes(metadataToken);
        Console.WriteLine(BitConverter.ToString(bytes2));
        Array.Copy(bytes2, <span style="color:#ae81ff">0</span>, array2, j * <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">4</span>);
    }
    Aes aes = <span style="color:#66d9ef">new</span> Aes(array, array2);
    <span style="color:#66d9ef">byte</span>[] bytes3 = aes.DecryptFromBase64String(<span style="color:#e6db74">&#34;fQjMpHu5cK122YUeJHX8T5wzTKbVhVZcNcCvSGSedV8=&#34;</span>);
    Console.WriteLine(<span style="color:#e6db74">&#34;Good job. Flag: &#34;</span> + Encoding.ASCII.GetString(bytes3));
}
</code></pre></div><p>It decrypts another Base64 string using a computed AES key. This key results from calling</p>
<pre><code>frames[1].GetMethod().MetadataToken
</code></pre><p>and doing some magic stuff with it afterwards. The important thing to notice is that it&rsquo;s using <code>frames[1]</code>, which doesn&rsquo;t exist when executing this second stage as a standalone binary. This stack frame must result from <code>CampRE.dll</code> calling this embedded second stage.</p>
<p>I decided to patch out the <code>BADBOY</code> check above and construct a new loader for the second stage:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
{
    <span style="color:#66d9ef">try</span>
    {
        Assembly.Load(File.ReadAllBytes(<span style="color:#e6db74">&#34;Foo.dll&#34;</span>)).EntryPoint.Invoke(<span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>[]
        {
            <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">string</span>[]
            {
                <span style="color:#e6db74">&#34;NOT_A_BADBOY&#34;</span>
            }
        });
    }
    <span style="color:#66d9ef">catch</span> (Exception) {}
}
</code></pre></div><p>This mimics <code>CampRE.dll</code> decrypting and calling the embedded second stage, while the <code>MetadataToken</code> from which the AES key is computed remains intact since the call stack is the same.</p>
<p>After re-compiling and running this, the flag is being printed:</p>
<p><img src="/img/dotnet-re-cccamp19/flag.jpg" alt="yay"></p>
<p>Peace out, thanks to <a href="https://twitter.com/allesctf">ALLES CTF</a> and 0x4d5a for this challenge!</p>
</div>

    
    

    

    <h4 id="related" class="page-header">Related</h4>

     <div class="item">

    
    
    

    

    <h4><a href="/post/d3dhook/">Game Hacking #3: Hooking Direct3D EndScene()</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/reverse-engineering"><kbd class="item-tag">reverse-engineering</kbd></a>
    
    <a href="https://bananamafia.dev/tags/c&#43;&#43;"><kbd class="item-tag">c&#43;&#43;</kbd></a>
    
    <a href="https://bananamafia.dev/tags/binary"><kbd class="item-tag">binary</kbd></a>
    
    <a href="https://bananamafia.dev/tags/gamehacking"><kbd class="item-tag">gamehacking</kbd></a>
    
    <a href="https://bananamafia.dev/tags/hooking"><kbd class="item-tag">hooking</kbd></a>
    

</div>
  <div class="item">

    
    
    

    

    <h4><a href="/post/srop/">SROP Exploitation with radare2</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/r2"><kbd class="item-tag">r2</kbd></a>
    
    <a href="https://bananamafia.dev/tags/radare2"><kbd class="item-tag">radare2</kbd></a>
    
    <a href="https://bananamafia.dev/tags/rop"><kbd class="item-tag">rop</kbd></a>
    
    <a href="https://bananamafia.dev/tags/exploitation"><kbd class="item-tag">exploitation</kbd></a>
    
    <a href="https://bananamafia.dev/tags/ctf"><kbd class="item-tag">ctf</kbd></a>
    

</div>
  <div class="item">

    
    
    

    

    <h4><a href="/post/mem/">MemLabs: An Introduction To Memory Forensics</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/forensics"><kbd class="item-tag">forensics</kbd></a>
    
    <a href="https://bananamafia.dev/tags/ctf"><kbd class="item-tag">ctf</kbd></a>
    
    <a href="https://bananamafia.dev/tags/volatility"><kbd class="item-tag">volatility</kbd></a>
    

</div>
 

    

</main>
<footer id="footer">
    <img style="width:42vh" src="/img/tag.png" class="alt-img" id="mafia-tag">

    <p class="copyright text-muted">

        Â© All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a>
    </p>
</footer>
</body>

<script>
    var footerWidth = 200;
    $(document).ready(function () {
        setWidth();
        $(window).bind("resize", setWidth);
    });

    $(window).on('load', function () {
        setWidth();
    });

    function setWidth() {
        footerWidth = $("main").width();

        $("#footer").css("min-width", (footerWidth > 300 ? footerWidth : 300) + "px");
        
    }

    $(window).on('resize', function () {
        setWidth();
    });

</script>

</html>


<script>
    var width = 200;
    $(document).ready(function () {
        setMaxWidth();
        $(window).bind("resize", setMaxWidth);
    });


    function setMaxWidth() {
        $("pre > code").css("display", "none");
        $("pre").css("display", "none");

        width = $("#related").width();

        $("pre > code").css("display", "block");
        $("pre").css("display", "block");

        $("pre > code").css("maxWidth", (width) + "px");
        $("pre").css("maxWidth", (width) + "px");
    }

    $(window).on('resize', function () {
        setMaxWidth();
    });

    $(window).on('load', function () {
        setMaxWidth();
    });



</script>