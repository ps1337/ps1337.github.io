<!DOCTYPE html>
<html lang="en-us">

<head>
     
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Game Hacking #2: Coding A CS:GO Hack</title>
    <style>

    html body {
        font-family: 'Raleway', sans-serif;
        background-color: white;
    }

    :root {
        --border-width:  5px ;
    }

</style>





<link rel="stylesheet" href="https://bananamafia.dev//css/font.css">


 <link rel="stylesheet" href="https://bananamafia.dev//css/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://bananamafia.dev//css/bootstrap-min.css" integrity="">


<link rel="stylesheet" href="https://bananamafia.dev//css/main.css">


<link rel="stylesheet" href="https://bananamafia.dev//css/font-awesome.min.css" integrity="">

 


<script src="/js/highlight.min.js"></script>


<script src="/js/python.min.js"></script> 
<script src="/js/cpp.min.js"></script> 
<script src="/js/json.min.js"></script> 
<script src="/js/go.min.js"></script> 

<script>
  hljs.initHighlightingOnLoad();
</script>




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-143157939-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-143157939-1');
</script>





















<script src="/js/jquery.min.js"></script>


<script src="/js/bootstrap.min.js"></script>


<script>$(document).on('click', function () { $('.collapse').collapse('hide'); })</script>


<script src="/js/confetti.browser.js"></script> <meta name="generator" content="Hugo 0.85.0" />
    

    
</head>




<body>
     
    <nav class="navbar navbar-default navbar-fixed-top">

        <div class="container">

            <div class="navbar-header">

                <a class="navbar-brand visible-xs" href="#">Game Hacking #2: Coding A CS:GO Hack</a>

                <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

            </div>

            <div class="collapse navbar-collapse">

                
                <ul class="nav navbar-nav">
                    
                    <li><a href="/">Home</a></li>
                    
                    <li><a href="/post/">Posts</a></li>
                    
                    <li><a href="/project/">Projects</a></li>
                    
                    <li><a href="/recipe/">Recipes</a></li>
                    
                </ul>
                

                
                <ul class="nav navbar-nav navbar-right">
                    
                    <li class="navbar-icon"><a href="mailto:banana-#@#-bananamafia.dev"><i class="fa fa-envelope-o"></i></a></li>
                    
                    <li class="navbar-icon"><a href="https://github.com/ps1337/"><i class="fa fa-github"></i></a></li>
                    
                    <li class="navbar-icon"><a href="https://twitter.com/CaptnBanana"><i class="fa fa-twitter"></i></a></li>
                    
                    <li class="navbar-icon"><a href="/index.xml"><i class="fa fa-rss"></i></a></li>
                    
                    <li class="navbar-icon"><a href=""><i class="fa fa-toggle-off"></i></a></li>
                    
                    <li class="navbar-icon"><a href="https://www.youtube.com/watch?v=ao2GL3NAWQU"><i class="fa fa-envira"></i></a></li>
                    
                </ul>
                

            </div>

        </div>

    </nav>


    <script>
        
        
        

        
        $(".fa-toggle-off, .fa-toggle-on").parent().removeAttr("href");

        
        window.onload = setMode();

        function isLightMode() {

            const currentTheme = localStorage.getItem('bananamafia_theme') ? localStorage.getItem('bananamafia_theme') : null;

            if (currentTheme == "light" || currentTheme == null) {
                return true;
            }
            else {
                return false;
            }
        }

        function setMode() {
            if (isLightMode()) {
                setLight();
            }
            else {
                setDark();
            }
        }

        function setDark() {
            document.documentElement.setAttribute('data-theme', 'dark');
            localStorage.setItem('bananamafia_theme', 'dark');

            $(".fa-toggle-off").each(function (i) {
                $(this).removeClass("fa-toggle-off");
                $(this).addClass("fa-toggle-on");
            });
            setAltImgs();
        }

        function setLight() {
            document.documentElement.setAttribute('data-theme', 'light');
            localStorage.setItem('bananamafia_theme', 'light');

            $(".fa-toggle-on").each(function (i) {
                $(this).removeClass("fa-toggle-on");
                $(this).addClass("fa-toggle-off");
            });
            setAltImgs();
        }

        function setAltImgs() {
            var lightMode = isLightMode();
            $(".alt-img").each(function (idx) {
                if (lightMode) {
                    
                    var newSrc = $(this).attr("src").replace("_dark", "");
                }
                else {
                    
                    var imgExt = $(this).attr("src").split(".").pop();
                    var newSrc = $(this).attr("src").substr(0, $(this).attr("src").lastIndexOf(".")) + "_dark." + imgExt;
                }

                $(this).fadeOut(250, function () {
                    $(this).attr("src", newSrc);
                });
                $(this).fadeIn(250);
            });
        }

        $(".fa-toggle-off, .fa-toggle-on").on("click", function () {
            const currentTheme = localStorage.getItem('bananamafia_theme') ? localStorage.getItem('bananamafia_theme') : null;
            $("body").addClass("transition-bg");
            $("nav").addClass("transition-bg");
            if (currentTheme == "dark") {
                setLight();
            } else {
                setDark();
            }

            setTimeout(function () {
                $("body").removeClass("transition-bg");
                $("nav").removeClass("transition-bg");
            }, 500);

        });

        $(document).ready(function () {
            
            $(".fa-envira").parent().mouseenter(function () {
                confetti.reset();

                confetti({
                    useWorker: true,
                    particleCount: 200,
                    angle: 90,
                    spread: 70,
                    origin: {
                        x: 0.5, y: 1
                    },
                    startVelocity: 60
                });
            });
            setAltImgs();
        });
    </script>


<main id="main">

    <div class="item">

    
    
    

    

    <h4><a href="/post/bananabot/">Game Hacking #2: Coding A CS:GO Hack</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/reverse-engineering"><kbd class="item-tag">reverse-engineering</kbd></a>
    
    <a href="https://bananamafia.dev/tags/c&#43;&#43;"><kbd class="item-tag">c&#43;&#43;</kbd></a>
    
    <a href="https://bananamafia.dev/tags/binary"><kbd class="item-tag">binary</kbd></a>
    
    <a href="https://bananamafia.dev/tags/gamehacking"><kbd class="item-tag">gamehacking</kbd></a>
    

</div>


    <br>
    <div class="content-width text-justify"><p>This post covers creating a hack for the game Counter Strike: Global Offensive. The hack I&rsquo;ve developed works in combination with the Linux version of the game - coding a windows-based hack can however be done with the same methodology and tools.</p>
<p>These are the features I&rsquo;ve integrated into the hack:</p>
<ul>
<li>Bunnyhop Bot: Do jumps as soon as the player hits the ground to make it easier to perform bunny hop chains</li>
<li>No Flash: Be immune to flash grenades that would block the players vision</li>
<li>Aimbot: Automatically aim at the head of the nearest enemy</li>
</ul>
<h1 id="tooling--setup">Tooling &amp; Setup</h1>
<p>Linux lacks of good tools to perform the kind of analysis tasks required to code a cheat like this. There are <code>pince</code> and <code>scanmem</code> available but they only provide a limited set of the required features. In the Windows world, there&rsquo;s handy tool called <a href="https://github.com/cheat-engine/cheat-engine">Cheat Engine</a> that is capable of all the required tasks, like:</p>
<ul>
<li>Searching for addresses in the memory space of the target process by performing filter-based searches</li>
<li>Pointer scan: Search for pointers to addresses</li>
<li>Debugger: Determine functions that read and write from/to specific addresses</li>
</ul>
<p>Fortunately, Cheat Engine is split into two parts: <a href="https://aur.archlinux.org/packages/ceserver/"><code>ceserver</code></a> and the GUI. It&rsquo;s possible to launch the Linux version of <code>ceserver</code> natively and launch the GUI using <code>wine</code>. The GUI can then be connected to the server using a local socket. Of course, <code>ceserver</code> has to be run as <code>root</code> in order to read and write memory of arbitrary target processes. This setup is semi-stable but still the best for Linux at the moment, at least in my opinion :)</p>
<h1 id="basics">Basics</h1>
<p>Once Cheat Engine is attached to the CS:GO process, it can access the whole memory space of that process. This also includes the shared objects that are present in the target memory. The memory layout can be inspected with <code>cat /proc/&lt;PID&gt;/maps</code>.</p>
<p>Once a game client is connected to a network game, it doesn&rsquo;t only know the local player&rsquo;s health and location but also the respective values of all team mates and enemies. The game wouldn&rsquo;t show it of course, but the information is present in the process memory. Objects and structures in this memory are structured according to the game engine&rsquo;s <a href="https://github.com/ValveSoftware/source-sdk-2013/">source code</a>. The developers of CS:GO however applied some changes in regard to the released SDK, so some things may still be different in the actual game memory.</p>
<p>The class <code>CBaseEntity</code> is, among other things, responsible for managing the data of player objects. All values present in that memory structure can be found in the <a href="https://github.com/ValveSoftware/source-sdk-2013/blob/master/mp/src/game/server/baseentity.h">SDK source code</a>.</p>
<p>A general approach is to find the exact location of these data structures in the game memory in order to analyze and reverse engineer them. For example, enemy locations can be read and other values can be written in order to achieve a certain goal. Please note that it&rsquo;s not as simple as finding a memory location and using the address of the memory structure in the hack because this value changes upon restarting the game. To get around this, a <em>static</em> pointer to the address or a static pointer to a pointer (and so on) to the address are required. The game executable and the loaded libraries may contain static pointers that lead to the start of a data structure in game memory at runtime.</p>
<p>For example, the shared object that manages the players in the game is called <code>client_panorama_client.so</code>. This library contains a static pointer to a data structure in game memory that in turn contains the <code>CBaseEntity</code> object of the current player at a specific offset:</p>
<center>
<img src="/img/bananabot/mem_ptr.png">
</center>
<p><em>Note: This data structure is sometimes also called &ldquo;player base&rdquo; or &ldquo;local player&rdquo;.</em></p>
<p>This means that it&rsquo;s possible to use these <em>multi level pointers</em> to consistently find the desired data structures in memory, even across game restarts. Please keep in mind that you need a <em>static</em> pointer for this or otherwise the pointer may not be valid after a game restart.</p>
<p>The <em>pointer scan</em> feature of Cheat Engine helps when performing this analysis step by searching for all pointers that point to a given address, like the beginning of the <code>CBaseEntity</code>. An easy approach to determine whether a given pointer is static or not is to add it to list in Cheat Engine and restarting the game multiple times. If it&rsquo;s still valid, it may be static and you can use it in the cheat.</p>
<p>After the game was updated, certain offsets and addresses may be changed, since some parts have been re-compiled, added or removed. To overcome this issue, you can use dumpers such as <a href="https://github.com/Teklad/tuxdump">tuxdump</a> or <a href="https://github.com/frk1/hazedumper">hazedumper</a>. These tools are able to read the offsets to various in-game structures by making use of pattern matching. In case of <code>hazedumper</code>, updating offsets is as convenient as downloading a new version of the <a href="https://github.com/frk1/hazedumper/blob/master/csgo.hpp">csgo.hpp</a> header file, since it&rsquo;s being updated automatically after CS:GO updates have been released on Steam. I didn&rsquo;t use these dumpers, since I&rsquo;ve reverse engineered the memory layout manually but you are of course free to use it to make your life easier.</p>
<h1 id="bunnyhop-bot">Bunnyhop Bot</h1>
<p>With the <code>CBaseEntity</code> object now being available to the hack, it&rsquo;s possible to detect whether the player is currently on the ground or not. There&rsquo;s a boolean value in this data structures that stores this information.</p>
<p>The only other thing required for bunnyhopping is invoking jumps programmatically. Of course, sending a key event may be a working solution. However, the cheat can&rsquo;t be sure which key the player actually uses for jumping. Because of this, another approach has been implemented.</p>
<p>The game uses certain memory addresses as interrupts. As soon as a special value is present at one address, the game invokes a jump all by itself. The jump interrupt address can be found with the following approach:</p>
<ul>
<li>Scan for <em>unknown initial 4 byte value</em> in Cheat Engine</li>
<li>In the in-game console type <code>+jump</code>. This tells the game that the jump button has been pressed and is being held</li>
<li>Search for <em>changed value</em></li>
<li>Type <code>-jump</code>, which tells the game that the jump button has been released</li>
<li>Search for <em>changed value</em></li>
<li>Repeat until only a few addresses are remaining</li>
</ul>
<p>By reverse engineering the game, it can be found that writing the value <code>0x06</code> to the correct interrupt address will cause the player to perform a jump. The remaining addresses can be filtered by writing this value to them. If no jump has been invoked, it&rsquo;s the wrong address.</p>
<p>After finding a static pointer to this interrupt address, bunny hopping can be implemented easily.</p>
<h1 id="no-flash">No Flash</h1>
<p>It turns out that the game keeps an internal counter that&rsquo;s initially set to a high value once the player gets <em>flashed</em>. After each frame this counter gets decremented and over time the flash effect slowly fades. To stop the flash effect it&rsquo;s therefore required to write a zero value to this specific address. Cheat engine once again helps in finding the correct address and static pointer to this value.</p>
<p>The following animation shows what happens when a player gets flashed without
and with the hack activated:</p>
<center>
<img src="/img/bananabot/noflash.gif">
</center>
<h1 id="aimbot">Aimbot</h1>
<p>There are quite some steps required in order to get this work. The local player&rsquo;s location, as in X, Y and Z coordinates can be found in the <code>CBaseEntity</code> structure that has been found before. Every additional required step is covered in its own section.</p>
<h2 id="getting-enemy-locations">Getting Enemy Locations</h2>
<p>The enemy locations can be found by making use of various methods. In my cheat, I&rsquo;ve used the so-called <code>GlowObjectManager</code> method. This is a structure in memory that, for whatever reason, holds structures that include pointers to all entities on the map (<code>CBaseEntity</code> structures). Each sub-structure is <code>0x40</code> bytes large and starts with the entity pointer element. The manager structure also contains a counter value that can be used in order to loop through all available entities in a loop.</p>
<p>The location of enemy entities on the map can be read directly from memory. Determining the offset of the entity locations can be accomplished by pushing players around and watching the memory change:</p>
<center>
<img src="/img/bananabot/entitypos.gif">
</center>
<p>Dead enemies and team mates can be filtered by making use of other member values of <code>CBaseEntity</code>. The values that are present in the determined memory regions have to be converted to <code>float</code>s before processing this data any further.</p>
<h2 id="getting-the-nearest-enemy">Getting the Nearest Enemy</h2>
<p>With the local player&rsquo;s and all enemy coordinates ready, it&rsquo;s quite easy to determine the nearest enemy using mad math skills:</p>
<pre><code>return std::sqrt(std::pow(entity_x - own_x, 2) + std::pow(entity_y - own_y, 2) + std::pow(entity_z - own_z, 2));
</code></pre><h2 id="setting-the-camera-angle">Setting the Camera Angle</h2>
<p>After using the in-game console command <code>cl_showpos 1</code>, the current camera angle can be displayed on the screen. By moving the mouse and searching for changed values in Cheat Engine, multiple addresses can be found that hold the current camera angle. However, only one can be used to actually set this angle programmatically.</p>
<h2 id="calculating-the-camera-angle">Calculating the Camera Angle</h2>
<p>The only thing that&rsquo;s still required is calculating the camera angle in order to automatically aim at the enemy. The following function takes the local player&rsquo;s and the enemy coordinates and magically calculates this angle:</p>
<pre><code>// Slightly modified standard `CalculateAngle` function.
std::vector&lt;float&gt; MadMath::calcAngle(std::vector&lt;float&gt; src, std::vector&lt;float&gt; dst)
{
    std::vector&lt;float&gt; angles;
    std::vector&lt;double&gt; delta = {src[0] - dst[0], src[1] - dst[1], src[2] - dst[2]};
    double hyp = std::sqrt(delta[0] * delta[0] + delta[2] * delta[2]);

    angles.push_back((float)(asinf(delta[1] / hyp) * RADIANT));
    angles.push_back((float)(atanf(delta[2] / delta[0]) * RADIANT));
    angles.push_back(0);

    if (delta[0] &gt;= 0)
    {
        angles[1] += 180.0f;
    }

    return angles;
}
</code></pre><p>This works because of reasons and it&rsquo;s great. Check out <a href="https://www.youtube.com/watch?v=sDd8aBCCBbA">this video by
GuidedHacking</a> if you want to
learn why and how this works.</p>
<p>Below you can find a demonstration of the aimbot:</p>
<center>
<img src="/img/bananabot/demo_1.gif">
<img src="/img/bananabot/demo_2.gif">
<img src="/img/bananabot/demo_3.gif">
<img src="/img/bananabot/demo_4.gif">
</center>
<h1 id="playing-online">Playing Online</h1>
<p>It definitively works but you will get banned because the aimbot just aims through walls, no matter if the enemy can actually be seen or not :D</p>
<h1 id="references">References</h1>
<ul>
<li><a href="https://www.youtube.com/watch?v=RpnFoSIlw8s">How To Make An Aimbot in C++</a></li>
<li><a href="https://github.com/frk1/hazedumper/">Hazedumper</a></li>
<li><a href="https://github.com/schroeji/pengWin/">PengWin</a></li>
</ul>
</div>

    
    

    

    <h4 id="related" class="page-header">Related</h4>

     <div class="item">

    
    
    

    

    <h4><a href="/post/satisfyer/">Analysis of Satisfyer Toys: Discovering an Authentication Bypass with r2 and Frida</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/radare2"><kbd class="item-tag">radare2</kbd></a>
    
    <a href="https://bananamafia.dev/tags/r2"><kbd class="item-tag">r2</kbd></a>
    
    <a href="https://bananamafia.dev/tags/frida"><kbd class="item-tag">frida</kbd></a>
    
    <a href="https://bananamafia.dev/tags/r2frida"><kbd class="item-tag">r2frida</kbd></a>
    
    <a href="https://bananamafia.dev/tags/reverse-engineering"><kbd class="item-tag">reverse-engineering</kbd></a>
    
    <a href="https://bananamafia.dev/tags/web"><kbd class="item-tag">web</kbd></a>
    
    <a href="https://bananamafia.dev/tags/vulnerability"><kbd class="item-tag">vulnerability</kbd></a>
    

</div>
  <div class="item">

    
    
    

    

    <h4><a href="/post/hisensehax/">Haxxoring a Hisense Smart TV</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/exploitation"><kbd class="item-tag">exploitation</kbd></a>
    
    <a href="https://bananamafia.dev/tags/reverse-engineering"><kbd class="item-tag">reverse-engineering</kbd></a>
    
    <a href="https://bananamafia.dev/tags/vulnerability"><kbd class="item-tag">vulnerability</kbd></a>
    

</div>
  <div class="item">

    
    
    

    

    <h4><a href="/post/d3dhook/">Game Hacking #3: Hooking Direct3D EndScene()</a></h4>
    <h5></h5>
    
    <a href="https://bananamafia.dev/tags/reverse-engineering"><kbd class="item-tag">reverse-engineering</kbd></a>
    
    <a href="https://bananamafia.dev/tags/c&#43;&#43;"><kbd class="item-tag">c&#43;&#43;</kbd></a>
    
    <a href="https://bananamafia.dev/tags/binary"><kbd class="item-tag">binary</kbd></a>
    
    <a href="https://bananamafia.dev/tags/gamehacking"><kbd class="item-tag">gamehacking</kbd></a>
    
    <a href="https://bananamafia.dev/tags/hooking"><kbd class="item-tag">hooking</kbd></a>
    

</div>
 

    

</main>
<footer id="footer">
    <img style="width:42vh" src="/img/tag.png" class="alt-img" id="mafia-tag">

    <p class="copyright text-muted">

        © All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a>
    </p>
</footer>
</body>

<script>
    var footerWidth = 200;
    $(document).ready(function () {
        setWidth();
        $(window).bind("resize", setWidth);
    });

    $(window).on('load', function () {
        setWidth();
    });

    function setWidth() {
        footerWidth = $("main").width();

        $("#footer").css("min-width", (footerWidth > 300 ? footerWidth : 300) + "px");
        
    }

    $(window).on('resize', function () {
        setWidth();
    });

</script>

</html>


<script>
    var width = 200;
    $(document).ready(function () {
        setMaxWidth();
        $(window).bind("resize", setMaxWidth);
    });


    function setMaxWidth() {
        $("pre > code").css("display", "none");
        $("pre").css("display", "none");

        width = $("#related").width();

        $("pre > code").css("display", "block");
        $("pre").css("display", "block");

        $("pre > code").css("maxWidth", (width) + "px");
        $("pre").css("maxWidth", (width) + "px");
    }

    $(window).on('resize', function () {
        setMaxWidth();
    });

    $(window).on('load', function () {
        setMaxWidth();
    });



</script>